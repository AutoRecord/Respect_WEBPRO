# アプローチA（1シート統合）における1対多関係の扱い

## 問題：1建物に複数の室・空調・照明がある場合

WEBPROデータは以下のような**1対多の階層構造**を持っています：

```
建物（1）
├── 室（多）
│   ├── 照明器具（多）
│   └── 給湯箇所（多）
├── 空調ゾーン（多）
│   └── 外皮（多）
├── 熱源群（多）
│   └── 熱源機器（多）
├── 空調機群（多）
└── 換気機器（多）
```

**1シートに統合する場合、この階層をどう「平坦化」するかがポイントです。**

---

## パターン1：室を基準に行展開（推奨）

### 考え方
- **室（部屋）を1行の単位**とする
- 室に紐づく照明・空調ゾーンは同じ行に配置
- 室に紐づかない熱源・空調機は別途集約

### データ例

#### ケース：〇〇ビル（建物001）
- 室：3室（事務室A、会議室、事務室B）
- 空調ゾーン：2ゾーン（1F事務、2F事務）
- 熱源：1群（空冷チラー×2台）
- 照明：各室に2種類の照明器具

```
┌────────┬────────────┬──────────┬────────┬─────────────┬───────────┬──────────┬─────────────┬───────────┬───────────────┬───────────────┐
│file_id │building    │room_floor│room_name│room_area    │zone_name  │hs_group  │hs_type      │light_1_name│light_1_power │light_2_name   │
├────────┼────────────┼──────────┼────────┼─────────────┼───────────┼──────────┼─────────────┼───────────┼───────────────┼───────────────┤
│001     │〇〇ビル    │1F        │事務室A  │120.5        │1F事務     │熱源群1   │空冷チラー   │LED-A      │40             │ダウンライト   │
│001     │〇〇ビル    │1F        │会議室   │30.0         │1F事務     │熱源群1   │空冷チラー   │LED-B      │32             │-              │
│001     │〇〇ビル    │2F        │事務室B  │150.0        │2F事務     │熱源群1   │空冷チラー   │LED-A      │40             │ダウンライト   │
└────────┴────────────┴──────────┴────────┴─────────────┴───────────┴──────────┴─────────────┴───────────┴───────────────┴───────────────┘
```

### メリット
- 直感的で理解しやすい
- 室単位の集計が容易

### デメリット
- 照明器具が3種類以上ある室は列が増える（light_3, light_4...）
- 熱源情報が全室で重複（冗長）

---

## パターン2：最小単位で行展開

### 考え方
- **最も細かい単位（照明器具1台）を1行**とする
- 建物・室情報は繰り返し記載

### データ例

```
┌────────┬────────────┬──────────┬────────┬─────────────┬───────────┬──────────┬─────────────┬───────────┬─────────────┐
│file_id │building    │room_floor│room_name│room_area    │zone_name  │hs_group  │hs_type      │light_name │light_power  │
├────────┼────────────┼──────────┼────────┼─────────────┼───────────┼──────────┼─────────────┼───────────┼─────────────┤
│001     │〇〇ビル    │1F        │事務室A  │120.5        │1F事務     │熱源群1   │空冷チラー   │LED-A      │40           │
│001     │〇〇ビル    │1F        │事務室A  │120.5        │1F事務     │熱源群1   │空冷チラー   │ダウンライト│20           │
│001     │〇〇ビル    │1F        │会議室   │30.0         │1F事務     │熱源群1   │空冷チラー   │LED-B      │32           │
│001     │〇〇ビル    │2F        │事務室B  │150.0        │2F事務     │熱源群1   │空冷チラー   │LED-A      │40           │
│001     │〇〇ビル    │2F        │事務室B  │150.0        │2F事務     │熱源群1   │空冷チラー   │ダウンライト│20           │
└────────┴────────────┴──────────┴────────┴─────────────┴───────────┴──────────┴─────────────┴───────────┴─────────────┘
```

### メリット
- 列数が固定（増えない）
- 照明器具ごとの詳細分析が容易

### デメリット
- **行数が大幅に増加**（室数×照明種類数）
- 室面積の合計時に重複カウントの注意が必要

```python
# 注意：単純にsumすると重複カウント
# NG
total_area = df['room_area'].sum()

# OK（重複を除去）
total_area = df.drop_duplicates(['file_id', 'room_name'])['room_area'].sum()
```

---

## パターン3：エンティティ別に行展開（ハイブリッド）

### 考え方
- **行の種類を示す列（entity_type）を追加**
- 建物・室・熱源・照明をそれぞれ別の行として記録

### データ例

```
┌────────┬─────────────┬────────────┬──────────┬────────┬─────────────┬───────────┬───────────┬─────────────┐
│file_id │entity_type  │building    │room_floor│room_name│room_area    │hs_type    │light_name │light_power  │
├────────┼─────────────┼────────────┼──────────┼────────┼─────────────┼───────────┼───────────┼─────────────┤
│001     │building     │〇〇ビル    │-         │-        │-            │-          │-          │-            │
│001     │room         │〇〇ビル    │1F        │事務室A  │120.5        │-          │-          │-            │
│001     │room         │〇〇ビル    │1F        │会議室   │30.0         │-          │-          │-            │
│001     │room         │〇〇ビル    │2F        │事務室B  │150.0        │-          │-          │-            │
│001     │heatsource   │〇〇ビル    │-         │-        │-            │空冷チラー │-          │-            │
│001     │lighting     │〇〇ビル    │1F        │事務室A  │-            │-          │LED-A      │40           │
│001     │lighting     │〇〇ビル    │1F        │事務室A  │-            │-          │ダウンライト│20           │
│001     │lighting     │〇〇ビル    │1F        │会議室   │-            │-          │LED-B      │32           │
└────────┴─────────────┴────────────┴──────────┴────────┴─────────────┴───────────┴───────────┴─────────────┘
```

### メリット
- 各エンティティの関係が明確
- 正規化に近い構造

### デメリット
- **クエリが複雑になる**
- 1つの分析に複数のフィルタリングが必要

```python
# 室データだけ取得
df_rooms = df[df['entity_type'] == 'room']

# 照明データだけ取得
df_lights = df[df['entity_type'] == 'lighting']
```

---

## 結論：アプローチ比較表

| パターン | 行数 | 列数 | 集計のしやすさ | 推奨用途 |
|----------|------|------|----------------|----------|
| パターン1（室基準） | 中 | 多（可変） | ◎ | **汎用的な分析** |
| パターン2（最小単位） | 多 | 少（固定） | △（注意必要） | 照明・機器詳細分析 |
| パターン3（エンティティ別） | 多 | 中 | ○ | データベース連携 |

---

## 【重要】アプローチAの限界

**1シートに統合する場合、以下の問題が避けられません：**

1. **データの冗長性** - 建物情報・熱源情報が各行で重複
2. **NULL値の多発** - 室に紐づかない項目は空白に
3. **集計時の注意** - 重複カウントを避ける処理が必要

### 本質的な解決策

**アプローチB（様式別シート）であれば、これらの問題は発生しません。**

```
建物情報シート（100行）─┐
                        ├─ file_id で結合
室情報シート（2000行）──┤
                        ├─ file_id + room_name で結合
照明情報シート（5000行）┘
```

```python
# 必要に応じて結合
df_merged = df_rooms.merge(df_lights, on=['file_id', 'room_name'])
```

---

## 推奨

| Python処理の目的 | 推奨アプローチ |
|------------------|----------------|
| シンプルな全体集計 | A（パターン1：室基準） |
| 詳細な機器分析 | B（様式別シート） |
| データベース連携 | B（様式別シート） |
| 複雑なクロス分析 | B（様式別シート） |

**結論：1対多の関係が複雑な場合は、アプローチBの方が扱いやすいです。**
